<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <title>Clasificador de Aves</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">



    <style type="text/css">
        #resultado {
            font-weight: bold;
            font-size: 2rem;
            text-align: center;
        }
    </style>
</head>
<body>

    <main>
        <div class="px-4 py-2 my-2 text-center border-bottom">
            <img class="d-block mx-auto mb-2" src="LogotipoV2-Simple.png" alt="" width="80" height="80">
            <h1 class="display-5 fw-bold">Bird classification</h1>
            <div class="col-lg-6 mx-auto">
                <p class="lead mb-0">Clasificación de imágenes de aves utilizando la cámara web y Tensorflow.js</p>
            </div>
        </div>
        <div class="b-example-divider"></div>
    
        <div class="container mt-5">
            <div class="row">
                <div class="col-12 col-md-4 offset-md-4 text-center">
                    <video id="video" playsinline autoplay style="width: 100%;"></video>
                    <button id="cambiar-camara" onclick="cambiarCamara();">Cambiar cámara</button>
                    <canvas id="canvas" width="400" height="400" style="max-width: 100%; display: none;"></canvas>
                    <div id="resultado"></div>
                    <div id="informacion-importante" class="mt-3">
                    </div>
                </div>
            </div>
        </div>
    
        <div class="b-example-divider"></div>
    
        <div class="bg-dark text-secondary mt-5 px-4 py-2 text-center">
            <div class="py-5">
                <h1 class="display-5 fw-bold text-white">Galapagos Birds: Classification and Conservation</h1>
                <div class="col-lg-6 mx-auto">
                    <p class="fs-5 mb-4">Visit the website of the  <a href="https://www.darwinfoundation.org/en/">Charles Darwin Foundation</a> a non-profit organization dedicated to scientific research and conservation of the Galapagos Islands.</p>
                </div>
            </div>
        </div>
    
        <div class="b-example-divider mb-0"></div>
    
    
    </main>


    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <script src="model.json"></script>

    <script type="text/javascript">
        var tamano = 400;
        var video = document.getElementById("video");
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        var currentStream = null;
        var facingMode = "user";

        var modelo = null;

        async function cargarModelo() {
            console.log("Cargando modelo...");
            modelo = await tf.loadLayersModel("model.json");
            console.log("Modelo cargado");
        }

        // Mostrar la información importante según el tipo de usuario
        function mostrarInformacionImportante(tipoUsuario) {
            var informacionImportanteElement = document.getElementById("informacion-importante");

            // Información importante de cada clase
            var informacionImportante = {
                "Albatross": {
                    "niño": "Información para niños sobre el Albatros",
                    "turista": "Información para turistas sobre el Albatros",
                    "biologo": "Información para biólogos sobre el Albatros"
                },
                "American Coot": {
                    "niño": "Información para niños sobre el American Coot",
                    "turista": "Información para turistas sobre el American Coot",
                    "biologo": "Información para biólogos sobre el American Coot"
                },
                "Barn Swallow": {
                    "niño": "Información para niños sobre el Barn Swallow",
                    "turista": "Información para turistas sobre el Barn Swallow",
                    "biologo": "Información para biólogos sobre el Barn Swallow"
                },
                "Belted Kingfisher": {
                    "niño": "Información para niños sobre el Belted Kingfisher",
                    "turista": "Información para turistas sobre el Belted Kingfisher",
                    "biologo": "Información para biólogos sobre el Belted Kingfisher"
                },
                "Black billed Cuckoo": {
                    "niño": "Información para niños sobre el BlackbilledCuckoo",
                    "turista": "Información para turistas sobre el BlackbilledCuckoo",
                    "biologo": "Información para biólogos sobre el BlackbilledCuckoo"
                },
                "Blue Heron": {
                    "niño": "Información para niños sobre el Blue Heron",
                    "turista": "Información para turistas sobre el Blue Heron",
                    "biologo": "Información para biólogos sobre el Blue Heron"
                },
                "Bobolink": {
                    "niño": "Información para niños sobre el Bobolink",
                    "turista": "Información para turistas sobre el Bobolink",
                    "biologo": "Información para biólogos sobre el Bobolink"
                },
                "Cattle Egret": {
                    "niño": "Información para niños sobre el Cattle Egret",
                    "turista": "Información para turistas sobre el Cattle Egret",
                    "biologo": "Información para biólogos sobre el Cattle Egret"
                },
                "Frigate": {
                    "niño": "Información para niños sobre el Frigate",
                    "turista": "Información para turistas sobre el Frigate",
                    "biologo": "Información para biólogos sobre el Frigate"
                },
                "Grey Plover": {
                    "niño": "Información para niños sobre el Grey Plover",
                    "turista": "Información para turistas sobre el Grey Plover",
                    "biologo": "Información para biólogos sobre el Grey Plover"
                },
                "Indigo Bunting": {
                    "niño": "Información para niños sobre el IndigoBunting",
                    "turista": "Información para turistas sobre el IndigoBunting",
                    "biologo": "Información para biólogos sobre el IndigoBunting"
                },
                "Laughing Gull": {
                    "niño": "Información para niños sobre el Laughing Gull",
                    "turista": "Información para turistas sobre el Laughing Gull",
                    "biologo": "Información para biólogos sobre el Laughing Gull"
                },
                "Long Tailed Jaeger": {
                    "niño": "Información para niños sobre el Long Tailed Jaeger",
                    "turista": "Información para turistas sobre el Long Tailed Jaeger",
                    "biologo": "Información para biólogos sobre el Long Tailed Jaeger"
                },
                "Osprey": {
                    "niño": "Información para niños sobre el Osprey",
                    "turista": "Información para turistas sobre el Osprey",
                    "biologo": "Información para biólogos sobre el Osprey"
                },
                "Pajaro Brujo San Cristobal": {
                    "niño": "Información para niños sobre el PajaroBrujoSanCristobal",
                    "turista": "Información para turistas sobre el PajaroBrujoSanCristobal",
                    "biologo": "Información para biólogos sobre el PajaroBrujoSanCristobal"
                },
                "Peregrine Falcon": {
                    "niño": "Información para niños sobre el Peregrine Falcon",
                    "turista": "Información para turistas sobre el Peregrine Falcon",
                    "biologo": "Información para biólogos sobre el Peregrine Falcon"
                },
                "Pied Billed Grebe": {
                    "niño": "Información para niños sobre el PiedBilledGrebe",
                    "turista": "Información para turistas sobre el PiedBilledGrebe",
                    "biologo": "Información para biólogos sobre el PiedBilledGrebe"
                },
                "Pomarine Jaeger": {
                    "niño": "Información para niños sobre el Pomarine Jaeger",
                    "turista": "Información para turistas sobre el Pomarine Jaeger",
                    "biologo": "Información para biólogos sobre el Pomarine Jaeger"
                },
                "Ring Billed Gull": {
                    "niño": "Información para niños sobre el Ring Billed Gull",
                    "turista": "Información para turistas sobre el Ring Billed Gull",
                    "biologo": "Información para biólogos sobre el Ring Billed Gull"
                },
                "Rock Dove": {
                    "niño": "Información para niños sobre el Rock Dove",
                    "turista": "Información para turistas sobre el Rock Dove",
                    "biologo": "Información para biólogos sobre el Rock Dove"
                },
                "Rose Breasted Grosbeak": {
                    "niño": "Información para niños sobre el Rose Breasted Grosbeak",
                    "turista": "Información para turistas sobre el Rose Breasted Grosbeak",
                    "biologo": "Información para biólogos sobre el Rose Breasted Grosbeak"
                },
                "Whimbrel": {
                    "niño": "Información para niños sobre el Whimbrel",
                    "turista": "Información para turistas sobre el Whimbrel",
                    "biologo": "Información para biólogos sobre el Whimbrel"
                },

                
            };

            // Crear elementos de lista para cada clase de ave
            for (var clave in informacionImportante) {
                if (informacionImportante.hasOwnProperty(clave)) {
                    var liElement = document.createElement("div");
                    liElement.className = "mb-2";
                    var infoToShow = informacionImportante[clave][tipoUsuario] || informacionImportante[clave]["common"];
                    liElement.innerHTML = `<strong>${clave}:</strong> ${infoToShow} (<a href="InfoAves/${clave}.html?tipoUsuario=${tipoUsuario}" target="_blank">Más información</a>)`;
                    informacionImportanteElement.appendChild(liElement);
                }
            }
        }

        window.onload = function() {
            // Obtener el tipo de usuario de la URL
            var urlParams = new URLSearchParams(window.location.search);
            var tipoUsuario = urlParams.get('tipoUsuario');

            // Mostrar el tipo de usuario (puedes hacer lo que necesites con esta información)
            console.log("Tipo de Usuario:", tipoUsuario);
            mostrarCamara();
            cargarModelo();
            mostrarInformacionImportante(tipoUsuario);
        }

        function mostrarCamara() {
            var opciones = {
                audio: false,
                video: {
                    width: tamano, height: tamano,
                    facingMode: facingMode
                }
            }

            navigator.mediaDevices.getUserMedia(opciones)
                .then(function(stream) {
                    currentStream = stream;
                    video.srcObject = currentStream;
                    procesarCamara();
                    predecir();
                })
                .catch(function(err) {
                    alert("No se pudo utilizar la cámara :(");
                    console.log(err);
                })
        }

        function cambiarCamara() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => {
                    track.stop();
                });
            }

            facingMode = facingMode === "user" ? "environment" : "user";

            var opciones = {
                audio: false,
                video: {
                    width: tamano, height: tamano,
                    facingMode: facingMode
                }
            };

            navigator.mediaDevices.getUserMedia(opciones)
                .then(function(stream) {
                    currentStream = stream;
                    video.srcObject = currentStream;
                })
                .catch(function(err) {
                    console.log("Oops, hubo un error", err);
                })
        }

        function procesarCamara() {
            ctx.drawImage(video, 0, 0, tamano, tamano, 0, 0, tamano, tamano);
            setTimeout(procesarCamara, 20);
        }

        function predecir() {
            if (modelo != null) {
                var canvasElement = document.getElementById("canvas");
                var ctx2 = canvasElement.getContext("2d");
                var imgData = ctx2.getImageData(0, 0, 224, 224);
                tf.browser.toPixels(imgData, canvasElement);
                var normalizedImg = tf.browser.fromPixels(canvasElement);
                normalizedImg = tf.image.resizeBilinear(normalizedImg, [224, 224]);
                normalizedImg = normalizedImg.div(255.0);
                var tensor = normalizedImg.expandDims(0);

                var resultado = modelo.predict(tensor).dataSync();
                var clasesAves = [                
                    "001.Black_footed_Albatross",
                    "042.Vermilion_Flycatcher",
                    "044.Frigatebird",
                    "182.Yellow_Warbler",
                    "Cattle Egret",
                    "013.Bobolink(de visita)",
                    "014.Indigo_Bunting(de visita)",
                    "031.Black_billed_Cuckoo(de visita)",
                    "052.Pied_billed_Grebe(de visita)",
                    "057.Rose_breasted_Grosbeak(de visita)",
                    "064.Ring_billed_Gull(de visita)",
                    "071.Long_tailed_Jaeger(de visita)",
                    "072.Pomarine_Jaeger(de visita)",
                    "079.Belted_Kingfisher(de visita)",
                    "092.Nighthawk(de visita)",
                    "100.Brown_Pelican(de visita)",
                    "135.Bank_Swallow(de visita)",
                    "136.Barn_Swallow(de visita)",
                    "137.Cliff_Swallow(de visita)",
                    "139.Scarlet_Tanager(de visita)",
                    "140.Summer_Tanager(de visita)",
                    "142.Black_Tern(de visita)",
                    "144.Common_Tern(de visita)",
                    "145.Elegant_Tern(de visita)",
                    "154.Red_eyed_Vireo(de visita)",
                    "177.Prothonotary_Warbler(de visita)",
                    "183.Northern_Waterthrush(de visita)",
                    "186.Cedar_Waxwing(de visita)",
                    "ALBATROSS",
                    "FRIGATE",
                    "GREY PLOVER",
                    "AMERICAN COOT(de visita)",
                    "BANANAQUIT(de visita)",
                    "BARN SWALLOW(de visita)",
                    "BELTED KINGFISHER(de visita)",
                    "BLUE HERON(de visita)",
                    "BOBOLINK(de visita)",
                    "CEDAR WAXWING(de visita)",
                    "CINNAMON TEAL(de visita)",
                    "CROW(de visita)",
                    "INCA TERN(de visita)",
                    "INDIGO BUNTING(de visita)",
                    "LAUGHING GULL(de vista)",
                    "NORTHERN SHOVELER(de visita)",
                    "OSPREY(de visita)",
                    "PEACOCK(de visita)",
                    "PEREGRINE FALCON(de visita)",
                    "POMARINE JAEGER(de visita)",
                    "PUFFIN(de visita)",
                    "PURPLE MARTIN(de visita)",
                    "RED KNOT(de visita)",
                    "ROCK DOVE(de visita)",
                    "SAND MARTIN(de visita)",
                    "SCARLET TANAGER(de visita)",
                    "SHORT BILLED DOWITCHER(de visita)",
                    "SNOWY EGRET(de visita)",
                    "SORA(de visita)",
                    "WHIMBREL(de visita)"
                ];
                var clasePredicha = clasesAves[resultado.indexOf(Math.max(...resultado))];
                document.getElementById("resultado").innerHTML = clasePredicha;
            }

            setTimeout(predecir, 150);
        }


    </script>
</body>
</html>